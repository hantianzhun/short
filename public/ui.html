<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>短链管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Material Design 3 Color System */
      --md-sys-color-primary: #6750A4;
      --md-sys-color-on-primary: #FFFFFF;
      --md-sys-color-primary-container: #EADDFF;
      --md-sys-color-on-primary-container: #21005D;
      
      --md-sys-color-surface: #FFFBFE;
      --md-sys-color-on-surface: #1C1B1F;
      --md-sys-color-surface-container: #F7F2FA;
      --md-sys-color-surface-container-high: #F0EAFA;
      
      --md-sys-color-outline: #79747E;
      --md-sys-color-outline-variant: #CAC4D0;
      
      --md-sys-color-error: #BA1A1A;
      --md-sys-color-on-error: #FFFFFF;
      --md-sys-color-error-container: #FFDAD6;
      
      --md-sys-color-shadow: rgba(0, 0, 0, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface);
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px;
    }

    h1 {
      font-size: 32px;
      font-weight: 400;
      line-height: 40px;
      letter-spacing: 0;
      margin: 0 0 32px;
      color: var(--md-sys-color-on-surface);
      text-align: center;
    }

    .card {
      background: var(--md-sys-color-surface);
      border-radius: 28px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0px 1px 3px 0px rgba(0, 0, 0, 0.3), 0px 4px 8px 3px rgba(0, 0, 0, 0.15);
      transition: box-shadow 0.3s ease;
      position: relative;
    }

    .card:hover {
      box-shadow: 0px 2px 6px 2px rgba(0, 0, 0, 0.3), 0px 8px 12px 6px rgba(0, 0, 0, 0.15);
    }

    /* MD3 Outlined Text Field */
    .text-field {
      position: relative;
      margin-bottom: 24px;
      animation: slideInUp 0.4s cubic-bezier(0.2, 0, 0, 1) backwards;
    }

    .text-field:nth-child(1) {
      animation-delay: 0.1s;
    }

    .text-field:nth-child(2) {
      animation-delay: 0.2s;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .text-field::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 2px;
      background: var(--md-sys-color-primary);
      transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
      transform: translateX(-50%);
    }

    .text-field:focus-within::after {
      width: 100%;
      left: 0;
      transform: translateX(0);
    }

    .text-field input {
      width: 100%;
      padding: 16px;
      font-family: 'Roboto', sans-serif;
      font-size: 16px;
      line-height: 24px;
      background: var(--md-sys-color-surface-container);
      border: none;
      border-bottom: 1px solid var(--md-sys-color-outline);
      border-radius: 4px 4px 0 0;
      outline: none;
      transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
      color: var(--md-sys-color-on-surface);
    }

    .text-field input:hover {
      background: var(--md-sys-color-surface-container-high);
      border-bottom-color: var(--md-sys-color-on-surface);
      transform: translateY(-2px);
    }

    .text-field input:focus {
      background: var(--md-sys-color-surface-container-high);
      border-bottom-color: transparent;
      padding-bottom: 15px;
      transform: translateY(-2px);
    }

    .text-field input::placeholder {
      color: var(--md-sys-color-outline);
      opacity: 0.6;
      transition: opacity 0.3s ease;
    }

    .text-field input:focus::placeholder {
      opacity: 0.4;
    }

    /* MD3 Filled Button */
    .btn-filled {
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      border: none;
      padding: 10px 24px;
      border-radius: 20px;
      font-family: 'Roboto', sans-serif;
      font-size: 14px;
      font-weight: 500;
      line-height: 20px;
      letter-spacing: 0.1px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      text-transform: none;
      margin-right: 8px;
      min-height: 40px;
    }

    .btn-filled:hover {
      box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
    }

    .btn-filled:active {
      box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
    }

    /* MD3 Outlined Button */
    .btn-outlined {
      background: transparent;
      color: var(--md-sys-color-primary);
      border: 1px solid var(--md-sys-color-outline);
      padding: 10px 24px;
      border-radius: 20px;
      font-family: 'Roboto', sans-serif;
      font-size: 14px;
      font-weight: 500;
      line-height: 20px;
      letter-spacing: 0.1px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: none;
      margin-right: 8px;
      min-height: 40px;
    }

    .btn-outlined:hover {
      background: rgba(103, 80, 164, 0.08);
    }

    /* MD3 Text Button */
    .btn-text {
      background: transparent;
      color: var(--md-sys-color-primary);
      border: none;
      padding: 10px 12px;
      border-radius: 20px;
      font-family: 'Roboto', sans-serif;
      font-size: 14px;
      font-weight: 500;
      line-height: 20px;
      letter-spacing: 0.1px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: none;
      margin-right: 8px;
      min-height: 40px;
    }

    .btn-text:hover {
      background: rgba(103, 80, 164, 0.08);
    }

    /* Action buttons with outline */
    .btn-action {
      background: transparent;
      color: var(--md-sys-color-primary);
      border: 1px solid var(--md-sys-color-outline);
      padding: 8px 16px;
      border-radius: 20px;
      font-family: 'Roboto', sans-serif;
      font-size: 14px;
      font-weight: 500;
      line-height: 20px;
      letter-spacing: 0.1px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: none;
      margin-right: 8px;
      min-height: 40px;
    }

    .btn-action:hover {
      background: rgba(103, 80, 164, 0.08);
      border-color: var(--md-sys-color-primary);
    }

    .btn-action-danger {
      color: var(--md-sys-color-error);
      border-color: var(--md-sys-color-error);
    }

    .btn-action-danger:hover {
      background: rgba(186, 26, 26, 0.08);
      border-color: var(--md-sys-color-error);
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
    }

    th {
      padding: 16px;
      text-align: left;
      font-size: 14px;
      font-weight: 500;
      line-height: 20px;
      letter-spacing: 0.1px;
      color: var(--md-sys-color-on-surface);
    }

    td {
      padding: 16px;
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      font-size: 14px;
      line-height: 20px;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-start;
      align-items: center;
    }

    td a {
      color: var(--md-sys-color-primary);
      text-decoration: none;
      font-weight: 500;
    }

    td a:hover {
      text-decoration: underline;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.32);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      animation: fadeIn 0.2s ease-out forwards;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .modal {
      background: var(--md-sys-color-surface);
      border-radius: 28px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0px 11px 15px -7px rgba(0, 0, 0, 0.2), 0px 24px 38px 3px rgba(0, 0, 0, 0.14), 0px 9px 46px 8px rgba(0, 0, 0, 0.12);
      transform: scale(0.9);
      animation: scaleIn 0.2s cubic-bezier(0, 0, 0.2, 1) forwards;
    }

    @keyframes scaleIn {
      to { transform: scale(1); }
    }

    .modal-title {
      font-size: 24px;
      font-weight: 400;
      line-height: 32px;
      margin-bottom: 16px;
      color: var(--md-sys-color-on-surface);
    }

    .modal-message {
      font-size: 14px;
      line-height: 20px;
      margin-bottom: 24px;
      color: var(--md-sys-color-on-surface);
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--md-sys-color-inverse-surface, #1C1B1F);
      color: var(--md-sys-color-inverse-on-surface, #FFFBFE);
      padding: 14px 16px;
      border-radius: 4px;
      box-shadow: 0px 3px 5px -1px rgba(0, 0, 0, 0.2), 0px 6px 10px 0px rgba(0, 0, 0, 0.14), 0px 1px 18px 0px rgba(0, 0, 0, 0.12);
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 280px;
      animation: slideUp 0.3s cubic-bezier(0, 0, 0.2, 1) forwards;
    }

    @keyframes slideUp {
      to {
        transform: translateX(-50%) translateY(0);
      }
    }

    .toast-icon {
      font-size: 20px;
    }

    /* Button visibility control */
    .desktop-goto-btn {
      display: inline-block;
    }
    .mobile-goto-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      display: none;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      h1 {
        font-size: 28px;
        line-height: 36px;
        margin-bottom: 24px;
      }

      .card {
        padding: 16px;
        border-radius: 24px;
      }

      table {
        display: block;
        overflow-x: auto;
      }

      thead {
        display: none !important;
      }

      #tableHead {
        display: none !important;
      }

      tbody {
        display: block;
      }

      tr {
        display: block;
        margin-bottom: 16px;
        background: var(--md-sys-color-surface);
        border-radius: 12px;
        padding: 16px;
        box-shadow: none;
        border: 1px solid var(--md-sys-color-outline-variant);
        position: relative; /* Essential for mobile button positioning */
      }

      td {
        display: block;
        padding: 8px 0;
        border-bottom: none;
      }

      td:before {
        content: attr(data-label) ": ";
        font-weight: 500;
        color: var(--md-sys-color-on-surface);
        display: inline-block;
        min-width: 80px;
      }

      td:last-child {
        padding-top: 12px;
        border-top: 1px solid var(--md-sys-color-outline-variant);
        margin-top: 8px;
        text-align: center;
      }

      td:last-child:before {
        display: none;
      }

      .action-buttons {
        justify-content: center;
        width: 100%;
      }

      td:last-child .btn-action {
        flex: 1;
        max-width: 120px;
        margin-right: 8px;
      }

      td:last-child .btn-action:last-child {
        margin-right: 0;
      }

      .btn-filled,
      .btn-outlined,
      .btn-text {
        width: 100%;
        margin-right: 0;
        margin-bottom: 8px;
      }

      .btn-filled:last-child,
      .btn-outlined:last-child,
      .btn-text:last-child {
        margin-bottom: 0;
      }

      /* Toggle button visibility for mobile */
      .desktop-goto-btn {
        display: none;
      }
      .mobile-goto-btn {
        display: block;
      }
    }

    /* Desktop specific styles for action buttons */
    @media (min-width: 769px) {
      .action-buttons {
        justify-content: flex-end;
      }
      
      td:last-child {
        text-align: right;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>短链管理</h1>

    <div class="card">
      <form id="createForm">
        <div class="text-field">
          <input name="code" placeholder="短码" required />
        </div>
        <div class="text-field">
          <input name="url" placeholder="目标 URL" type="url" required />
        </div>
        <button type="submit" class="btn-filled">创建短链</button>
      </form>
    </div>

    <div class="card" id="updateCard" style="display: none;">
      <h3 style="font-size: 22px; font-weight: 400; margin-bottom: 24px;">更新短链</h3>
      <form id="updateForm">
        <input type="hidden" name="code" id="updateCode" />
        <div class="text-field">
          <input name="url" id="updateUrl" placeholder="新目标 URL" type="url" required />
        </div>
        <button type="submit" class="btn-filled">更新</button>
        <button type="button" onclick="cancelUpdate()" class="btn-text">取消</button>
      </form>
    </div>

    <div class="card" id="listCard">
      <table>
        <thead id="tableHead" style="display: none;">
          <tr>
            <th>短码</th>
            <th>目标地址</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
      <div id="emptyState" style="text-align: center; padding: 48px 24px; color: var(--md-sys-color-outline);">
        <p style="font-size: 16px; margin-bottom: 8px;">暂无短链</p>
        <p style="font-size: 14px; opacity: 0.6;">创建您的第一个短链开始使用</p>
      </div>
    </div>
  </div>

  <script>
    const listEl = document.getElementById('list')

    function showConfirm(message, onConfirm, onCancel) {
      const overlay = document.createElement('div')
      overlay.className = 'modal-overlay'
      
      const modal = document.createElement('div')
      modal.className = 'modal'
      
      const title = document.createElement('div')
      title.className = 'modal-title'
      title.textContent = '确认操作'
      
      const messageDiv = document.createElement('div')
      messageDiv.className = 'modal-message'
      messageDiv.innerHTML = message
      
      const actions = document.createElement('div')
      actions.className = 'modal-actions'
      
      const cancelBtn = document.createElement('button')
      cancelBtn.className = 'btn-text'
      cancelBtn.setAttribute('data-action', 'cancel')
      cancelBtn.textContent = '取消'
      
      const confirmBtn = document.createElement('button')
      confirmBtn.className = 'btn-filled'
      confirmBtn.style.background = 'var(--md-sys-color-error)'
      confirmBtn.setAttribute('data-action', 'confirm')
      confirmBtn.textContent = '确认'
      
      actions.appendChild(cancelBtn)
      actions.appendChild(confirmBtn)
      modal.appendChild(title)
      modal.appendChild(messageDiv)
      modal.appendChild(actions)
      overlay.appendChild(modal)
      document.body.appendChild(overlay)

      const handleClick = (e) => {
        const action = e.target.getAttribute('data-action')
        if (action === 'confirm') {
          overlay.style.animation = 'fadeIn 0.2s ease-out reverse'
          setTimeout(() => overlay.remove(), 200)
          if (onConfirm) onConfirm()
        } else if (action === 'cancel' || e.target === overlay) {
          overlay.style.animation = 'fadeIn 0.2s ease-out reverse'
          setTimeout(() => overlay.remove(), 200)
          if (onCancel) onCancel()
        }
      }

      overlay.addEventListener('click', handleClick)
    }

    function showToast(message, type = 'error') {
      const toast = document.createElement('div')
      toast.className = 'toast'
      const icon = type === 'error' ? '❌' : '✅'
      toast.innerHTML = `
        <span class="toast-icon">${icon}</span>
        <span>${message}</span>
      `
      document.body.appendChild(toast)

      setTimeout(() => {
        toast.style.animation = 'slideUp 0.3s cubic-bezier(0, 0, 0.2, 1) reverse'
        setTimeout(() => toast.remove(), 300)
      }, 3000)
    }

    async function fetchList() {
      const res = await fetch('/api/list')
      const data = await res.json()
      const tableHead = document.getElementById('tableHead')
      const emptyState = document.getElementById('emptyState')
      const isMobile = window.innerWidth <= 768
      
      if (data.length === 0) {
        tableHead.style.display = 'none'
        emptyState.style.display = 'block'
        listEl.innerHTML = ''
      } else {
        // 移动端始终隐藏表头
        tableHead.style.display = isMobile ? 'none' : 'table-header-group'
        emptyState.style.display = 'none'
        listEl.innerHTML = data.map(item => `
          <tr>
            <td data-label="短码"><a href="/${item.code}" target="_blank">${item.code}</a></td>
            <td data-label="目标地址">${item.url}</td>
            <td data-label="操作">
              <button class="btn-action mobile-goto-btn" onclick="gotoShortLink('${item.code}')">转到</button>
              <div class="action-buttons">
                <button class="btn-action desktop-goto-btn" onclick="gotoShortLink('${item.code}')">转到</button>
                <button class="btn-action" onclick="update('${item.code}', '${item.url.replace(/'/g, "\\'")}')">更新</button>
                <button class="btn-action btn-action-danger" onclick="remove('${item.code}')">删除</button>
              </div>
            </td>
          </tr>
        `).join('')
      }
    }

    function gotoShortLink(code) {
      window.open(`/${code}`, '_blank')
    }

    // 窗口大小改变时重新检查
    window.addEventListener('resize', () => {
      const tableHead = document.getElementById('tableHead')
      const isMobile = window.innerWidth <= 768
      if (tableHead && document.getElementById('list').innerHTML) {
        tableHead.style.display = isMobile ? 'none' : 'table-header-group'
      }
    })

    function update(code, url) {
      document.getElementById('updateCode').value = code
      document.getElementById('updateUrl').value = url
      document.getElementById('updateCard').style.display = 'block'
      document.getElementById('updateCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' })
    }

    function cancelUpdate() {
      document.getElementById('updateCard').style.display = 'none'
      document.getElementById('updateForm').reset()
    }

    async function remove(code) {
      showConfirm(`确定要删除短码 <strong>"${code}"</strong> 吗？此操作无法撤销。`, async () => {
        try {
          const res = await fetch('/api/delete', {
            method: 'POST',
            body: new URLSearchParams({ code })
          })
          if (res.ok) {
            showToast('删除成功', 'success')
            fetchList()
          } else {
            const data = await res.json()
            showToast(data.error || '删除失败')
          }
        } catch (error) {
          showToast('删除失败: ' + error.message)
        }
      })
    }

    document.getElementById('createForm').addEventListener('submit', async e => {
      e.preventDefault()
      try {
        const form = new FormData(e.target)
        const res = await fetch('/api/create', { method: 'POST', body: form })
        const data = await res.json()
        if (res.ok) {
          showToast('创建成功', 'success')
          e.target.reset()
          fetchList()
        } else {
          showToast(data.error || '创建失败')
        }
      } catch (error) {
        showToast('创建失败: ' + error.message)
      }
    })

    document.getElementById('updateForm').addEventListener('submit', async e => {
      e.preventDefault()
      try {
        const form = new FormData(e.target)
        const res = await fetch('/api/update', { method: 'POST', body: form })
        const data = await res.json()
        if (res.ok) {
          showToast('更新成功', 'success')
          cancelUpdate()
          fetchList()
        } else {
          showToast(data.error || '更新失败')
        }
      } catch (error) {
        showToast('更新失败: ' + error.message)
      }
    })

    fetchList()
  </script>
</body>
</html>
